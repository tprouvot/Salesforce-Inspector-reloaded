import{RequestTransport as e}from"./RequestTransport.js";export class CallbackPollingTransport extends e{#a=0;accept(e,s,t){return!0}jsonpSend(e){console.log("jsonpSend...."),console.log("packet : "),console.log(e),console.log(e.url);let s=window.document.getElementsByTagName("head")[0],t=window.document.createElement("script"),n="_cometd_jsonp_"+this.#a++;window[n]=r=>{s.removeChild(t),delete window[n],e.onSuccess(r)};let r=e.url;r+=0>r.indexOf("?")?"?":"&",r+="jsonp="+n,r+="&message="+encodeURIComponent(e.body),t.src=r,t.async=!0!==e.sync,t.type="text/javascript",t.onerror=s=>{e.onError("jsonp "+s.type)},s.appendChild(t)}transportSend(e,s){let t=0,n=e.messages.length,r=[];for(;n>0;){let o=JSON.stringify(e.messages.slice(t,t+n)),i=e.url.length+encodeURI(o).length,a=this.configuration.maxURILength;if(i>a){if(1===n){let l="Bayeux message too big ("+i+" bytes, max is "+a+") for transport "+this;return this.setTimeout(()=>this.transportFailure(e,s,{exception:l}),0),!1}--n;continue}r.push(n),t+=n,n=e.messages.length-t}let c=e;if(r.length>1){let h=0,u=r[0];this.debug("Transport",this.type,"split",e.messages.length,"messages into",r.join(" + ")),(c=this.cometd._mixin(!1,{},e)).messages=e.messages.slice(h,u),c.onSuccess=e.onSuccess,c.onFailure=e.onFailure;for(let p=1;p<r.length;++p){let g=this.cometd._mixin(!1,{},e);h=u,u+=r[p],g.messages=e.messages.slice(h,u),g.onSuccess=e.onSuccess,g.onFailure=e.onFailure,this.send(g,s.metaConnect)}}this.debug("Transport",this.type,"sending request",s.id,"envelope",c);try{let m=!0;return this.jsonpSend({transport:this,url:c.url,sync:c.sync,headers:this.configuration.requestHeaders,body:JSON.stringify(c.messages),onSuccess:e=>{let t=!1;try{let n=this.convertToMessages(e);0===n.length?this.transportFailure(c,s,{httpCode:204}):(t=!0,this.transportSuccess(c,s,n))}catch(r){this.debug(r),t||this.transportFailure(c,s,{exception:r})}},onError:(e,t)=>{let n={reason:e,exception:t};m?this.setTimeout(()=>{this.transportFailure(c,s,n)},0):this.transportFailure(c,s,n)}}),m=!1,!0}catch(d){return this.setTimeout(()=>{this.transportFailure(c,s,{exception:d})},0),!1}}}
