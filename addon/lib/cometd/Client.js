import{TransportRegistry as e}from"./TransportRegistry.js";import{CallbackPollingTransport as t}from"./CallbackPollingTransport.js";import{LongPollingTransport as s}from"./LongPollingTransport.js";import{WebSocketTransport as i}from"./WebSocketTransport.js";function Scheduler(){let e=0,t={};this.register=s=>{let i=++e;return t[i]=s,i},this.unregister=e=>{let s=t[e];return delete t[e],s},this.setTimeout=(e,t)=>window.setTimeout(e,t),this.clearTimeout=e=>{window.clearTimeout(e)}}function WorkerScheduler(){let e={};self.onmessage=t=>{let s=t.data,i=e[s.id];switch(s.type){case"setTimeout":e[s.id]=self.setTimeout(()=>{delete e[s.id],self.postMessage({id:s.id})},s.delay);break;case"clearTimeout":delete e[s.id],i&&self.clearTimeout(i);break;default:throw Error("Unknown command "+s.type)}}}export class CometD{#a=new Scheduler;#b;#c=!1;#d=new e;#e;#f="disconnected";#g=0;#h=null;#i=0;#j=[];#k=!1;#l=0;#m={};#n={};#o=0;#p=null;#q=[];#r={};#s;#t;#u={};#v={};#w=!1;#x=!1;#y=0;#z=0;#A=null;#B={useWorkerScheduler:!0,protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,maxSendBayeuxMessageSize:8192,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};constructor(e){this.#b=e||"default",window.WebSocket&&this.registerTransport("websocket",new i),this.registerTransport("long-polling",new s),this.registerTransport("callback-polling",new t)}static #C(n,a){try{return n[a]}catch(o){return}}_mixin(e,t,s){let i=t||{};for(let n=2;n<arguments.length;++n){let a=arguments[n];if(null!=a){for(let o in a)if(a.hasOwnProperty(o)){let r=CometD.#C(a,o),h=CometD.#C(i,o);if(r===t||void 0===r)continue;if(e&&"object"==typeof r&&null!==r){if(r instanceof Array)i[o]=this._mixin(e,h instanceof Array?h:[],r);else{let c="object"!=typeof h||h instanceof Array?{}:h;i[o]=this._mixin(e,c,r)}}else i[o]=r}}}return i}static #D(r){return null!=r&&("string"==typeof r||r instanceof String)}static #E(h){return h>="A"&&h<="Z"||h>="a"&&h<="z"}static #F(c){return c>="0"&&c<="9"}static #G(l){switch(l){case" ":case"!":case"#":case"$":case"(":case")":case"*":case"+":case"-":case".":case"/":case"@":case"_":case"{":case"~":case"}":return!0;default:return!1}}static #H(u){if(!CometD.#D(u)||u.length<2||"/"!==u.charAt(0))return!1;for(let d=1;d<u.length;++d){let g=u.charAt(d);if(!(CometD.#E(g)||CometD.#F(g)||CometD.#G(g)))return!1}return!0}static #I(f){return null!=f&&"function"==typeof f}static #J(m,p){let b="";for(;--p>0&&!(m>=Math.pow(10,p));)b+="0";return b+m}#K(k,$){if(window.console){let y=window.console[k];if(CometD.#I(y)){let C=new Date;[].splice.call($,0,0,CometD.#J(C.getHours(),2)+":"+CometD.#J(C.getMinutes(),2)+":"+CometD.#J(C.getSeconds(),2)+"."+CometD.#J(C.getMilliseconds(),3)),y.apply(window.console,$)}}}_warn(){this.#K("warn",arguments)}_info(){"warn"!==this.#B.logLevel&&this.#K("info",arguments)}_debug(){"debug"===this.#B.logLevel&&this.#K("debug",arguments)}static #L(x){return RegExp("(^https?://)?(((\\[[^\\]]+])|([^:/?#]+))(:(\\d+))?)?([^?#]*)(.*)?").exec(x)}#M(v){return!!window.location&&!!window.location.host&&!!v&&v!==window.location.host}#N(T){this._debug("Configuring cometd object with",T),CometD.#D(T)&&(T={url:T}),T||(T={}),this.#B=this._mixin(!1,this.#B,T);let D=this.getURL();if(!D)throw Error("Missing required configuration parameter 'url' specifying the Bayeux server URL");let w=CometD.#L(D),_=w[2],L=w[8],I=w[9];if(this.#c=this.#M(_),this.#B.appendMessageTypeToURL){if(void 0!==I&&I.length>0)this._info("Appending message type to URI",L,I,"is not supported, disabling 'appendMessageTypeToURL' configuration"),this.#B.appendMessageTypeToURL=!1;else{let S=L.split("/"),F=S.length-1;L.match(/\/$/)&&(F-=1),S[F].indexOf(".")>=0&&(this._info("Appending message type to URI",L,"is not supported, disabling 'appendMessageTypeToURL' configuration"),this.#B.appendMessageTypeToURL=!1)}}if(window.Worker&&window.Blob&&window.URL&&this.#B.useWorkerScheduler){let B=WorkerScheduler.toString();B=B.substring(B.indexOf("{")+1,B.lastIndexOf("}"));let R=new window.Blob([B],{type:"application/json"}),M=window.URL.createObjectURL(R),U=new window.Worker(M);this.#a.setTimeout=(e,t)=>{let s=this.#a.register(e);return U.postMessage({id:s,type:"setTimeout",delay:t}),s},this.#a.clearTimeout=e=>{this.#a.unregister(e),U.postMessage({id:e,type:"clearTimeout"})},U.onmessage=e=>{let t=e.data.id,s=this.#a.unregister(t);s&&s()}}}#O(E){if(E){let P=this.#m[E.channel];P&&P[E.id]&&(delete P[E.id],this._debug("Removed",E.listener?"listener":"subscription",E))}}#P(q){q&&!q.listener&&this.#O(q)}#Q(){for(let A in this.#m)if(this.#m.hasOwnProperty(A)){let O=this.#m[A];if(O)for(let j in O)O.hasOwnProperty(j)&&this.#P(O[j])}}#R(N){let z=this.getStatus();z!==N&&(this._debug("Status",z,"->",N),this.#f=N)}#S(){let H=this.#f;return"disconnecting"===H||"disconnected"===H}#T(){let W=++this.#g;return""+W}#U(Q,V,Z,G,J){try{return V.call(Q,G)}catch(K){let X=this.onExtensionException;if(CometD.#I(X)){this._debug("Invoking extension exception handler",Z,K);try{X.call(this,K,Z,J,G)}catch(Y){this._info("Exception during execution of extension exception handler",Z,Y)}}else this._info("Exception during execution of extension",Z,K);return G}}#V(ee){for(let et=0;et<this.#q.length&&null!=ee;++et){let es=this.#q[et],ei=es.extension.incoming;if(CometD.#I(ei)){let en=this.#U(es.extension,ei,es.name,ee,!1);ee=void 0===en?ee:en}}return ee}#W(ea){for(let eo=this.#q.length-1;eo>=0&&null!=ea;--eo){let er=this.#q[eo],eh=er.extension.outgoing;if(CometD.#I(eh)){let ec=this.#U(er.extension,eh,er.name,ea,!0);ea=void 0===ec?ea:ec}}return ea}#X(el,eu){let ed=this.#m[el];if(ed){for(let eg in ed)if(ed.hasOwnProperty(eg)){let ef=ed[eg];if(ef)try{ef.callback.call(ef.scope,eu)}catch(em){let ep=this.onListenerException;if(CometD.#I(ep)){this._debug("Invoking listener exception handler",ef,em);try{ep.call(this,em,ef,ef.listener,eu)}catch(eb){this._info("Exception during execution of listener exception handler",ef,eb)}}else this._info("Exception during execution of listener",ef,eu,em)}}}}#Y(ek,e$){this.#X(ek,e$);let ey=ek.split("/"),eC=ey.length-1;for(let ex=eC;ex>0;--ex){let ev=ey.slice(0,ex).join("/")+"/*";ex===eC&&this.#X(ev,e$),ev+="*",this.#X(ev,e$)}}#Z(){null!==this.#p&&this.clearTimeout(this.#p),this.#p=null}#$(eT,eD){this.#Z();let ew=this.#r.interval+eD;this._debug("Function scheduled in",ew,"ms, interval =",this.#r.interval,"backoff =",this.#o,eT),this.#p=this.setTimeout(eT,ew)}#_(e8,e_,eL){for(let eI=0;eI<e8.length;++eI){let eS=e8[eI],eF=eS.id,eB=this.getClientId();eB&&(eS.clientId=eB),void 0!==(eS=this.#W(eS))&&null!==eS?(eS.id=eF,e8[eI]=eS):(delete this.#u[eF],e8.splice(eI--,1))}if(0===e8.length)return;e_&&(this.#A=e8[0]);let eR=this.getURL();this.#B.appendMessageTypeToURL&&(eR.match(/\/$/)||(eR+="/"),eL&&(eR+=eL));let eM={url:eR,sync:!1,messages:e8,onSuccess:e=>{try{this.#aa(e)}catch(t){this._info("Exception during handling of messages",t)}},onFailure:(e,t,s)=>{try{let i=this.getTransport();s.connectionType=i?i.type:"unknown",this.#ab(e,t,s)}catch(n){this._info("Exception during handling of failure",n)}}};this._debug("Send",eM),this.getTransport().send(eM,e_)}#ac(eU){this.#i>0||!0===this.#k?this.#j.push(eU):this.#_([eU],!1)}send(e){this.#ac(e)}#ad(){this.#o=0}#ae(){return this.#o<this.#B.maxBackoff&&(this.#o+=this.getBackoffIncrement()),this.#o}#af(){++this.#i,this._debug("Starting batch, depth",this.#i)}#ag(){let eE=this.#j;this.#j=[],eE.length>0&&this.#_(eE,!1)}#ah(){if(--this.#i,this._debug("Ending batch, depth",this.#i),this.#i<0)throw Error("Calls to startBatch() and endBatch() are not paired");0!==this.#i||this.isDisconnected()||this.#k||this.#ag()}#ai(){if(!this.isDisconnected()){let eP={id:this.#T(),channel:"/meta/connect",connectionType:this.getTransport().type};this.#x||(eP.advice={timeout:0}),this.#R("connecting"),this._debug("Connect sent",eP),this.#_([eP],!0,"connect"),this.#R("connected")}}#aj(e0){this.#R("connecting"),this.#$(()=>{this.#ai()},e0)}#ak(eq){eq&&(this.#r=this._mixin(!1,{},this.#B.advice,eq),this._debug("New advice",this.#r))}#al(eA){this.#Z();let eO=this.getTransport();if(eA&&eO&&eO.abort(),this.#c=!1,this.#e=null,this.#R("disconnected"),this.#h=null,this.#i=0,this.#ad(),this.#w=!1,this.#x=!1,this.#y=0,this.#A=null,this.#j.length>0){let ej=this.#j;this.#j=[],this.#ab(void 0,ej,{reason:"Disconnected"})}}#am(eN,ez,eH){let eW=this.onTransportException;if(CometD.#I(eW)){this._debug("Invoking transport exception handler",eN,ez,eH);try{eW.call(this,eH,eN,ez)}catch(eQ){this._info("Exception during execution of transport exception handler",eQ)}}}#an(eV,e4){CometD.#I(eV)&&(e4=eV,eV=void 0),this.#h=null,this.clearSubscriptions(),this.isDisconnected()&&this.#d.reset(!0),this.#ak({}),this.#i=0,this.#k=!0,this.#s=eV,this.#t=e4;let e7=this.getURL(),e9=this.#d.findTransportTypes("1.0",this.#c,e7),e6={id:this.#T(),version:"1.0",minimumVersion:"1.0",channel:"/meta/handshake",supportedConnectionTypes:e9,advice:{timeout:this.#r.timeout,interval:this.#r.interval}},eZ=this._mixin(!1,{},this.#s,e6);if(this._putCallback(eZ.id,e4),!this.#e&&(this.#e=this.#d.negotiateTransport(e9,"1.0",this.#c,e7),!this.#e)){let e1="Could not find initial transport among: "+this.getTransportTypes();throw this._warn(e1),Error(e1)}this._debug("Initial transport is",this.#e.type),this.#R("handshaking"),this._debug("Handshake sent",eZ),this.#_([eZ],!1,"handshake")}#ao(e2){this.#R("handshaking"),this.#k=!0,this.#$(()=>{this.#an(this.#s,this.#t)},e2)}#ap(eG,eJ){try{eG.call(this,eJ)}catch(eK){let eX=this.onCallbackException;if(CometD.#I(eX)){this._debug("Invoking callback exception handler",eK);try{eX.call(this,eK,eJ)}catch(eY){this._info("Exception during execution of callback exception handler",eY)}}else this._info("Exception during execution of message callback",eK)}}_getCallback(e){return this.#u[e]}_putCallback(e,t){let s=this._getCallback(e);return CometD.#I(t)&&(this.#u[e]=t),s}#aq(e3){let e5=this._getCallback([e3.id]);CometD.#I(e5)&&(delete this.#u[e3.id],this.#ap(e5,e3))}#ar(te){let tt=this.#v[te.id];if(delete this.#v[te.id],tt){this._debug("Handling remote call response for",te,"with context",tt);let ts=tt.timeout;ts&&this.clearTimeout(ts);let ti=tt.callback;if(CometD.#I(ti))return this.#ap(ti,te),!0}return!1}onTransportFailure(e,t,s){this._debug("Transport failure",t,"for",e);let i=this.getTransportRegistry(),n=this.getURL(),a=this.#M(CometD.#L(n)[2]),o=i.findTransportTypes("1.0",a,n);if("none"===t.action){if("/meta/handshake"===e.channel&&!t.transport){let r="Could not negotiate transport, client=["+o+"], server=["+e.supportedConnectionTypes+"]";this._warn(r);let h=this.getTransport();if(h){let c=h.type;this.#am(c,null,{reason:r,connectionType:c,transport:h})}}}else if(t.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel){if(!t.transport){let l=this.#e?this.#e.type:null,u=i.negotiateTransport(o,"1.0",a,n);if(u){let d=u.type;this._debug("Transport",l,"->",d),this.#am(l,d,e.failure),t.action="handshake",t.transport=u}else this._warn("Could not negotiate transport, client=["+o+"]"),this.#am(l,null,e.failure),t.action="none"}"none"!==t.action&&this.increaseBackoffPeriod()}else{let g=new Date().getTime();if(0===this.#y&&(this.#y=g),"retry"===t.action){t.delay=this.increaseBackoffPeriod();let f=this.#r.maxInterval;if(f>0){let m=this.#r.timeout+this.#r.interval+f,p=g-this.#y;p+this.#o>m&&(t.action="handshake")}}"handshake"===t.action&&(t.delay=0,i.reset(!1),this.resetBackoffPeriod())}s.call(this,t)}#as(tn){this._debug("Transport failure handling",tn),tn.transport&&(this.#e=tn.transport),tn.url&&(this.#e.url=tn.url);let ta=tn.action,to=tn.delay||0;switch(ta){case"handshake":this.#ao(to);break;case"retry":this.#aj(to);break;case"none":this.#al(!0);break;default:throw Error("Unknown action "+ta)}}#at(tr,th){this.#aq(tr),this.#Y("/meta/handshake",tr),this.#Y("/meta/unsuccessful",tr),this.isDisconnected()&&(th.action="none"),this.onTransportFailure(tr,th,e=>this.#as(e))}#au(tc){let tl=this.getURL();if(tc.successful){let tu=this.#M(CometD.#L(tl)[2]),td=this.#d.negotiateTransport(tc.supportedConnectionTypes,tc.version,tu,tl);if(null===td){tc.successful=!1,this.#at(tc,{cause:"negotiation",action:"none",transport:null});return}{let tg=this.#e;tg!==td&&(this._debug("Transport",tg&&tg.type,"->",td.type),this.#e=td)}this.#h=tc.clientId,this.#k=!1,this.#ag(),tc.reestablish=this.#w,this.#w=!0,this.#aq(tc),this.#Y("/meta/handshake",tc),this.#z=tc["x-messages"]||0;let tf=this.isDisconnected()?"none":this.#r.reconnect||"retry";switch(tf){case"retry":this.#ad(),0===this.#z?this.#aj(0):this._debug("Processing",this.#z,"handshake-delivered messages");break;case"none":this.#al(!0);break;default:throw Error("Unrecognized advice action "+tf)}}else this.#at(tc,{cause:"unsuccessful",action:this.#r.reconnect||"handshake",transport:this.getTransport()})}#av(tm){this.#at(tm,{cause:"failure",action:"handshake",transport:null})}#aw(tp){return"disconnected"===this.getStatus()||!!this.#A&&this.#A.id===tp.id&&(this.#A=null,!0)}#ax(tb,tk){this.#Y("/meta/connect",tb),this.#Y("/meta/unsuccessful",tb),this.isDisconnected()&&(tk.action="none"),this.onTransportFailure(tb,tk,e=>this.#as(e))}#ay(t$){if(this.#aw(t$)){if(this.#x=t$.successful,this.#x){this.#Y("/meta/connect",t$);let ty=this.isDisconnected()?"none":this.#r.reconnect||"retry";switch(ty){case"retry":this.#ad(),this.#aj(this.#o);break;case"none":this.#al(!1);break;default:throw Error("Unrecognized advice action "+ty)}}else this.#ax(t$,{cause:"unsuccessful",action:this.#r.reconnect||"retry",transport:this.getTransport()})}else this._debug("Mismatched /meta/connect reply",t$)}#az(tC){this.#aw(tC)?(this.#x=!1,this.#ax(tC,{cause:"failure",action:"retry",transport:null})):this._debug("Mismatched /meta/connect failure",tC)}#aA(tx){this.#al(!0),this.#aq(tx),this.#Y("/meta/disconnect",tx),this.#Y("/meta/unsuccessful",tx)}#aB(tv){tv.successful?(this.#al(!1),this.#aq(tv),this.#Y("/meta/disconnect",tv)):this.#aA(tv)}#aC(tT){this.#aA(tT)}#aD(tD){let tw=this.#m[tD.subscription];if(tw){for(let t8 in tw)if(tw.hasOwnProperty(t8)){let t_=tw[t8];t_&&!t_.listener&&(delete tw[t8],this._debug("Removed failed subscription",t_))}}this.#aq(tD),this.#Y("/meta/subscribe",tD),this.#Y("/meta/unsuccessful",tD)}#aE(tL){tL.successful?(this.#aq(tL),this.#Y("/meta/subscribe",tL)):this.#aD(tL)}#aF(tI){this.#aD(tI)}#aG(tS){this.#aq(tS),this.#Y("/meta/unsubscribe",tS),this.#Y("/meta/unsuccessful",tS)}#aH(tF){tF.successful?(this.#aq(tF),this.#Y("/meta/unsubscribe",tF)):this.#aG(tF)}#aI(tB){this.#aG(tB)}#aJ(tR){this.#ar(tR)||(this.#aq(tR),this.#Y("/meta/publish",tR),this.#Y("/meta/unsuccessful",tR))}#aK(tM){void 0!==tM.data?!this.#ar(tM)&&(this.#Y(tM.channel,tM),this.#z>0&&(--this.#z,0===this.#z&&(this._debug("Processed last handshake-delivered message"),this.#aj(0)))):void 0===tM.successful?this._warn("Unknown Bayeux Message",tM):tM.successful?(this.#aq(tM),this.#Y("/meta/publish",tM)):this.#aJ(tM)}#aL(tU){this.#aJ(tU)}#aM(tE){if(this.#y=0,void 0===(tE=this.#V(tE))||null===tE)return;this.#ak(tE.advice);let tP=tE.channel;switch(tP){case"/meta/handshake":this.#au(tE);break;case"/meta/connect":this.#ay(tE);break;case"/meta/disconnect":this.#aB(tE);break;case"/meta/subscribe":this.#aE(tE);break;case"/meta/unsubscribe":this.#aH(tE);break;default:this.#aK(tE)}}receive(e){this.#aM(e)}#aa(t0){this._debug("Received",t0);for(let tq=0;tq<t0.length;++tq){let tA=t0[tq];this.receive(tA)}}#ab(tO,tj,tN){this._debug("handleFailure",tO,tj,tN),tN.transport=tO;for(let tz=0;tz<tj.length;++tz){let tH=tj[tz],tW={id:tH.id,successful:!1,channel:tH.channel,failure:tN};switch(tN.message=tH,tH.channel){case"/meta/handshake":this.#av(tW);break;case"/meta/connect":this.#az(tW);break;case"/meta/disconnect":this.#aC(tW);break;case"/meta/subscribe":tW.subscription=tH.subscription,this.#aF(tW);break;case"/meta/unsubscribe":tW.subscription=tH.subscription,this.#aI(tW);break;default:this.#aL(tW)}}}#aN(tQ){let tV=this.#m[tQ];if(tV){for(let t4 in tV)if(tV.hasOwnProperty(t4)&&tV[t4])return!0}return!1}#aO(t7,t9){let t6={scope:t7,method:t9};if(CometD.#I(t7))t6.scope=void 0,t6.method=t7;else if(CometD.#D(t9)){if(!t7)throw Error("Invalid scope "+t7);if(t6.method=t7[t9],!CometD.#I(t6.method))throw Error("Invalid callback "+t9+" for scope "+t7)}else if(!CometD.#I(t9))throw Error("Invalid callback "+t9);return t6}#aP(tZ,t1,t2,tG){let tJ=this.#aO(t1,t2);this._debug("Adding",tG?"listener":"subscription","on",tZ,"with scope",tJ.scope,"and callback",tJ.method);let tK=++this.#l,tX={id:tK,channel:tZ,scope:tJ.scope,callback:tJ.method,listener:tG},tY=this.#m[tZ];return tY||(tY={},this.#m[tZ]=tY),tY[tK]=tX,this._debug("Added",tG?"listener":"subscription",tX),tX}registerTransport(e,t,s){let i=this.#d.add(e,t,s);return i&&(this._debug("Registered transport",e),CometD.#I(t.registered)&&t.registered(e,this)),i}unregisterTransport(e){let t=this.#d.remove(e);return null!==t&&(this._debug("Unregistered transport",e),CometD.#I(t.unregistered)&&t.unregistered()),t}unregisterTransports(){this.#d.clear()}getTransportTypes(){return this.#d.getTransportTypes()}findTransport(e){return this.#d.find(e)}getTransportRegistry(){return this.#d}configure(e){this.#N(e)}init(e,t){this.configure(e),this.handshake(t)}handshake(e,t){let s=this.getStatus();if("disconnected"!==s)throw Error("Illegal state: "+s);this.#an(e,t)}disconnect(e,t){if(this.isDisconnected())return;CometD.#I(e)&&(t=e,e=void 0);let s={id:this.#T(),channel:"/meta/disconnect"},i=this._mixin(!1,{},e,s);this._putCallback(i.id,t),this.#R("disconnecting"),this.#_([i],!1,"disconnect")}startBatch(){this.#af()}endBatch(){this.#ah()}batch(e,t){let s=this.#aO(e,t);this.startBatch();try{s.method.call(s.scope),this.endBatch()}catch(i){throw this._info("Exception during execution of batch",i),this.endBatch(),i}}addTransportListener(e,t){if("timeout"!==e)throw Error("Unsupported event "+e);let s=this.#n[e];s||(this.#n[e]=s=[]),s.push(t)}removeTransportListener(e,t){let s=this.#n[e];if(s){let i=s.indexOf(t);if(i>=0)return s.splice(i,1),!0}return!1}_getTransportListeners(e){return this.#n[e]}addListener(e,t,s){if(arguments.length<2)throw Error("Illegal arguments number: required 2, got "+arguments.length);if(!CometD.#D(e))throw Error("Illegal argument type: channel must be a string");return this.#aP(e,t,s,!0)}removeListener(e){if(!e||!e.channel||!("id"in e))throw Error("Invalid argument: expected subscription, not "+e);this.#O(e)}clearListeners(){this.#m={}}subscribe(e,t,s,i,n){if(arguments.length<2)throw Error("Illegal arguments number: required 2, got "+arguments.length);if(!CometD.#H(e))throw Error("Illegal argument: invalid channel "+e);if(this.isDisconnected())throw Error("Illegal state: disconnected");CometD.#I(t)&&(n=i,i=s,s=t,t=void 0),CometD.#I(i)&&(n=i,i=void 0);let a=!this.#aN(e),o=this.#aP(e,t,s,!1);if(a){let r={id:this.#T(),channel:"/meta/subscribe",subscription:e},h=this._mixin(!1,{},i,r);this._putCallback(h.id,n),this.#ac(h)}else CometD.#I(n)&&this.setTimeout(()=>{this.#ap(n,{id:this.#T(),successful:!0,channel:"/meta/subscribe",subscription:e})},0);return o}unsubscribe(e,t,s){if(arguments.length<1)throw Error("Illegal arguments number: required 1, got "+arguments.length);if(this.isDisconnected())throw Error("Illegal state: disconnected");CometD.#I(t)&&(s=t,t=void 0),this.removeListener(e);let i=e.channel;if(this.#aN(i))CometD.#I(s)&&this.setTimeout(()=>{this.#ap(s,{id:this.#T(),successful:!0,channel:"/meta/unsubscribe",subscription:i})},0);else{let n={id:this.#T(),channel:"/meta/unsubscribe",subscription:i},a=this._mixin(!1,{},t,n);this._putCallback(a.id,s),this.#ac(a)}}resubscribe(e,t){if(this.#P(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)}clearSubscriptions(){this.#Q()}publish(e,t,s,i){if(arguments.length<1)throw Error("Illegal arguments number: required 1, got "+arguments.length);if(!CometD.#H(e))throw Error("Illegal argument: invalid channel "+e);if(/^\/meta\//.test(e))throw Error("Illegal argument: cannot publish to meta channels");if(this.isDisconnected())throw Error("Illegal state: disconnected");CometD.#I(t)?(i=t,t={},s=void 0):CometD.#I(s)&&(i=s,s=void 0);let n={id:this.#T(),channel:e,data:t},a=this._mixin(!1,{},s,n);this._putCallback(a.id,i),this.#ac(a)}publishBinary(e,t,s,i,n,a){CometD.#I(t)?(a=t,t=new ArrayBuffer(0),s=!0,i=void 0,n=void 0):CometD.#I(s)?(a=s,s=!0,i=void 0,n=void 0):CometD.#I(i)?(a=i,i=void 0,n=void 0):CometD.#I(n)&&(a=n,n=void 0);let o={meta:i,data:t,last:s},r=this._mixin(!1,n,{ext:{binary:{}}});this.publish(e,o,r,a)}remoteCall(e,t,s,i,n){if(arguments.length<1)throw Error("Illegal arguments number: required 1, got "+arguments.length);if(!CometD.#D(e))throw Error("Illegal argument type: target must be a string");if(this.isDisconnected())throw Error("Illegal state: disconnected");if(CometD.#I(t)?(n=t,t={},s=this.#B.maxNetworkDelay,i=void 0):CometD.#I(s)?(n=s,s=this.#B.maxNetworkDelay,i=void 0):CometD.#I(i)&&(n=i,i=void 0),"number"!=typeof s)throw Error("Illegal argument type: timeout must be a number");e.match(/^\//)||(e="/"+e);let a="/service"+e;if(!CometD.#H(a))throw Error("Illegal argument: invalid target "+e);let o={id:this.#T(),channel:a,data:t},r=this._mixin(!1,{},i,o),h={callback:n};s>0&&(h.timeout=this.setTimeout(()=>{this._debug("Timing out remote call",r,"after",s,"ms"),this.#aJ({id:r.id,error:"406::timeout",successful:!1,failure:{message:r,reason:"Remote Call Timeout"}})},s),this._debug("Scheduled remote call timeout",r,"in",s,"ms")),this.#v[r.id]=h,this.#ac(r)}remoteCallBinary(e,t,s,i,n,a,o){CometD.#I(t)?(o=t,t=new ArrayBuffer(0),s=!0,i=void 0,n=this.#B.maxNetworkDelay,a=void 0):CometD.#I(s)?(o=s,s=!0,i=void 0,n=this.#B.maxNetworkDelay,a=void 0):CometD.#I(i)?(o=i,i=void 0,n=this.#B.maxNetworkDelay,a=void 0):CometD.#I(n)?(o=n,n=this.#B.maxNetworkDelay,a=void 0):CometD.#I(a)&&(o=a,a=void 0);let r={meta:i,data:t,last:s},h=this._mixin(!1,a,{ext:{binary:{}}});this.remoteCall(e,r,n,h,o)}getStatus(){return this.#f}isDisconnected(){return this.#S()}setBackoffIncrement(e){this.#B.backoffIncrement=e}getBackoffIncrement(){return this.#B.backoffIncrement}getBackoffPeriod(){return this.#o}increaseBackoffPeriod(){return this.#ae()}resetBackoffPeriod(){this.#ad()}setLogLevel(e){this.#B.logLevel=e}registerExtension(e,t){if(arguments.length<2)throw Error("Illegal arguments number: required 2, got "+arguments.length);if(!CometD.#D(e))throw Error("Illegal argument type: extension name must be a string");let s=!1;for(let i=0;i<this.#q.length;++i){let n=this.#q[i];if(n.name===e){s=!0;break}}return s?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(this.#q.push({name:e,extension:t}),this._debug("Registered extension",e),CometD.#I(t.registered)&&t.registered(e,this),!0)}unregisterExtension(e){if(!CometD.#D(e))throw Error("Illegal argument type: extension name must be a string");let t=!1;for(let s=0;s<this.#q.length;++s){let i=this.#q[s];if(i.name===e){this.#q.splice(s,1),t=!0,this._debug("Unregistered extension",e);let n=i.extension;CometD.#I(n.unregistered)&&n.unregistered();break}}return t}getExtension(e){for(let t=0;t<this.#q.length;++t){let s=this.#q[t];if(s.name===e)return s.extension}return null}getName(){return this.#b}getClientId(){return this.#h}getURL(){let e=this.getTransport();if(e){let t=e.url;if(t||(t=this.#B.urls[e.type]))return t}return this.#B.url}getTransport(){return this.#e}getConfiguration(){return this._mixin(!0,{},this.#B)}getAdvice(){return this._mixin(!0,{},this.#r)}setTimeout(e,t){return this.#a.setTimeout(()=>{try{this._debug("Invoking timed function",e),e()}catch(t){this._debug("Exception invoking timed function",e,t)}},t)}clearTimeout(e){this.#a.clearTimeout(e)}}
