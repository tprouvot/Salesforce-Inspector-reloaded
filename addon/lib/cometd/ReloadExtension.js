import{Extension as e}from"./Extension.js";export class ReloadExtension extends e{#a={};#b="org.cometd.reload";#c=!1;#d=!1;constructor(e){super(),this.configure(e)}#e(t){if(this.#a.handshakeResponse){this.#d=!0;let s=this.cometd.getTransport();s&&s.abort(),this.configure(t);let a=JSON.stringify(this.#a);this.cometd._debug("Reload extension saving state",a),window.sessionStorage.setItem(this.#b,a)}}#f(n){return this.#a.url===n.url}configure(e){e&&"string"==typeof e.name&&(this.#b=e.name)}_receive(e){this.cometd.receive(e)}registered(e,t){super.registered(e,t),this.cometd.reload=e=>this.#e(e),this.cometd.addListener("/meta/handshake",e=>this.#g(e))}unregistered(){delete this.cometd.reload,super.unregistered()}outgoing(e){switch(e.channel){case"/meta/handshake":{this.#a={url:this.cometd.getURL()};let t=window.sessionStorage.getItem(this.#b);if(this.cometd._debug("Reload extension found state",t),t)try{let s=JSON.parse(t);if(window.sessionStorage.removeItem(this.#b),s.handshakeResponse&&this.#f(s)){this.cometd._debug("Reload extension restoring state",s);let a=this.cometd._getCallback(e.id);return this.cometd.setTimeout(()=>{this.cometd._debug("Reload extension replaying handshake response",s.handshakeResponse),this.#a.handshakeResponse=s.handshakeResponse,this.#a.transportType=s.transportType,this.cometd._putCallback(e.id,a);let t=this.cometd._mixin(!0,{},this.#a.handshakeResponse,{id:e.id,ext:{reload:!0}});t.supportedConnectionTypes=[this.#a.transportType],this._receive(t),this.cometd._debug("Reload extension replayed handshake response",t)},0),this.#c||(this.#c=!0,this.cometd.startBatch()),null}this.cometd._debug("Reload extension could not restore state",s)}catch(n){this.cometd._debug("Reload extension error while trying to restore state",n)}break}case"/meta/connect":if(!0===this.#d)return this.cometd._debug("Reload extension aborting /meta/connect during reload"),null;this.#a.transportType||(this.#a.transportType=e.connectionType,this.cometd._debug("Reload extension tracked transport type",this.#a.transportType));break;case"/meta/disconnect":this.#a={}}return e}incoming(e){switch(e.channel){case"/meta/handshake":e.successful&&!this.#a.handshakeResponse&&(this.#a.handshakeResponse=e,this.cometd._debug("Reload extension tracked handshake response",e));break;case"/meta/connect":this.#c&&(this.#c=!1,this.cometd.endBatch());break;case"/meta/disconnect":this.#c&&(this.#c=!1,this.cometd.endBatch()),this.#a={}}return e}#g(i){!0!==i.successful&&(this.#a={})}}
