import{Transport as e}from"./Transport.js";export class WebSocketTransport extends e{#a=!0;#b=!1;#c=!0;#d=null;#e=null;#f=!1;#g=null;reset(e){super.reset(e),this.#a=!0,e&&(this.#b=!1),this.#c=!0,e&&(this.#d=null),this.#e=null,this.#f=!1}#h(t,s){t&&(this.#i(t,s.code,s.reason),this.#j(t,s))}#k(o){return o===this.#e||o===this.#d}#l(i,n,c){let r=[];for(let h=0;h<n.messages.length;++h){let l=n.messages[h];l.id&&r.push(l.id)}i.envelopes[r.join(",")]=[n,c],this.debug("Transport",this.type,"stored envelope, envelopes",i.envelopes)}#m(a,p){let d=!1,u=a.envelopes;for(let m=0;m<p.length;++m){let g=p[m];for(let b in u)if(u.hasOwnProperty(b)){let $=b.split(","),T=$.indexOf(g);if(T>=0){d=!0,$.splice(T,1);let k=u[b][0],w=u[b][1];delete u[b],$.length>0&&(u[$.join(",")]=[k,w]);break}}}d&&this.debug("Transport",this.type,"removed envelope, envelopes",u)}#n(y){if(this.#e)return;let f=this.cometd.getURL().replace(/^http/,"ws");this.debug("Transport",this.type,"connecting to URL",f);try{let S=this.configuration.protocol;y.webSocket=S?new window.WebSocket(f,S):new window.WebSocket(f),this.#e=y}catch(x){throw this.#a=!1,this.debug("Exception while creating WebSocket object",x),x}this.#c=!1!==this.configuration.stickyReconnect;let v=this.configuration.connectTimeout;v>0&&(y.connectTimer=this.setTimeout(()=>{this.debug("Transport",this.type,"timed out while connecting to URL",f,":",v,"ms"),this.#h(y,{code:1e3,reason:"Connect Timeout"})},v));let _=()=>{this.debug("Transport",this.type,"onopen",y),y.connectTimer&&this.clearTimeout(y.connectTimer),this.#k(y)?(this.#e=null,this.#d=y,this.#b=!0,this.#o(y)):(this.cometd._warn("Closing extra WebSocket connection",this,"active connection",this.#d),this.#h(y,{code:1e3,reason:"Extra Connection"}))},C=e=>{e=e||{code:1e3},this.debug("Transport",this.type,"onclose",y,e,"connecting",this.#e,"current",this.#d),y.connectTimer&&this.clearTimeout(y.connectTimer),this.#j(y,e)},E=e=>{this.debug("Transport",this.type,"onmessage",e,y),this.#p(y,e)};y.webSocket.onopen=_,y.webSocket.onclose=C,y.webSocket.onerror=()=>{C({code:1e3,reason:"Error"})},y.webSocket.onmessage=E,this.debug("Transport",this.type,"configured callbacks on",y)}#q(O,R,W){let F=this.notifyTransportTimeout([R]);F>0?(this.debug("Transport",this.type,"extended waiting for message replies:",F,"ms"),O.timeouts[R.id]=this.setTimeout(()=>{this.#q(O,R,W+F)},F)):(this.debug("Transport",this.type,"expired waiting for message reply",R.id,":",W,"ms"),this.#h(O,{code:1e3,reason:"Message Timeout"}))}#r(j,P,L){let M;try{M=this.convertToJSON(P.messages)}catch(U){this.debug("Transport",this.type,"exception:",U);let D=[];for(let N=0;N<P.messages.length;++N){let A=P.messages[N];D.push(A.id)}this.#m(j,D),this.setTimeout(()=>{this._notifyFailure(P.onFailure,j,P.messages,{exception:U})},0);return}j.webSocket.send(M),this.debug("Transport",this.type,"sent",P,"/meta/connect =",L);let I=this.configuration.maxNetworkDelay;L&&(I+=this.advice.timeout,this.#f=!0);let J=[];for(let q=0;q<P.messages.length;++q){let z=P.messages[q];z.id&&(J.push(z.id),j.timeouts[z.id]=this.setTimeout(()=>{this.#q(j,z,I)},I))}this.debug("Transport",this.type,"started waiting for message replies",I,"ms, messageIds:",J,", timeouts:",j.timeouts)}_notifySuccess(e,t){e.call(this,t)}_notifyFailure(e,t,s,o){e.call(this,t,s,o)}#s(B,G,H){try{null===B?(B=this.#e||{envelopes:{},timeouts:{}},this.#l(B,G,H),this.#n(B)):(this.#l(B,G,H),this.#r(B,G,H))}catch(K){this.setTimeout(()=>{this.#h(B,{code:1e3,reason:"Exception",exception:K})},0)}}#o(Q){let V=Q.envelopes;for(let X in this.debug("Transport",this.type,"opened",Q,"pending messages",V),V)if(V.hasOwnProperty(X)){let Y=V[X],Z=Y[0],ee=Y[1];this.#g=Z.onSuccess,this.#r(Q,Z,ee)}}#p(et,es){this.debug("Transport",this.type,"received websocket message",es,et);let eo=!1,ei=this.convertToMessages(es.data),en=[];for(let ec=0;ec<ei.length;++ec){let er=ei[ec];if((/^\/meta\//.test(er.channel)||void 0===er.data)&&er.id){en.push(er.id);let eh=et.timeouts[er.id];eh&&(this.clearTimeout(eh),delete et.timeouts[er.id],this.debug("Transport",this.type,"removed timeout for message",er.id,", timeouts",et.timeouts))}"/meta/connect"===er.channel&&(this.#f=!1),"/meta/disconnect"!==er.channel||this.#f||(eo=!0)}this.#m(et,en),this._notifySuccess(this.#g,ei),eo&&this.#i(et,1e3,"Disconnect")}#j(el,ea){this.debug("Transport",this.type,"closed",el,ea),this.#k(el)&&(this.#a=this.#c&&this.#b,this.#e=null,this.#d=null);let ep=el.timeouts;for(let ed in el.timeouts={},ep)ep.hasOwnProperty(ed)&&this.clearTimeout(ep[ed]);let eu=el.envelopes;for(let em in el.envelopes={},eu)if(eu.hasOwnProperty(em)){let eg=eu[em][0],eb=eu[em][1];eb&&(this.#f=!1);let e$={websocketCode:ea.code,reason:ea.reason};ea.exception&&(e$.exception=ea.exception),this._notifyFailure(eg.onFailure,el,eg.messages,e$)}}accept(e,t,s){return this.debug("Transport",this.type,"accept, supported:",this.#a),this.#a&&!!window.WebSocket&&!1!==this.cometd.websocketEnabled}send(e,t){this.debug("Transport",this.type,"sending",e,"/meta/connect =",t),this.#s(this.#d,e,t)}#i(eT,ek,ew){try{eT.webSocket&&eT.webSocket.close(ek,ew)}catch(ey){this.debug(ey)}}abort(){super.abort(),this.#h(this.#d,{code:1e3,reason:"Abort"}),this.reset(!0)}}
